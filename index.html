<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Coach Vocal IA - Versi√≥n Simple</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea, #764ba2);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0;
            padding: 20px;
        }
        .container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        h1 { text-align: center; color: #333; }
        input, button {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border-radius: 8px;
            border: 1px solid #ddd;
            font-size: 16px;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
        }
        button:hover { background: #5a67d8; }
        button:disabled { opacity: 0.5; }
        .record-btn {
            background: #e53e3e;
            font-size: 20px;
            padding: 15px;
        }
        .record-btn.recording {
            animation: pulse 1s infinite;
            background: #c53030;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        .feedback {
            background: #f7fafc;
            border-radius: 8px;
            padding: 15px;
            min-height: 100px;
            margin-top: 20px;
            white-space: pre-wrap;
            border: 1px solid #e2e8f0;
        }
        .loading { display: none; text-align: center; margin: 10px 0; }
        .error { color: #e53e3e; margin: 10px 0; display: none; }
        .timer { text-align: center; font-size: 24px; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé§ Coach Vocal IA</h1>
        
        <input type="text" id="songName" placeholder="¬øQu√© canci√≥n vas a cantar?" value="d√≠gale david bisbal">
        
        <button class="record-btn" id="recordBtn">üé§ GRABAR</button>
        <div class="timer" id="timer">00:00</div>
        
        <button id="analyzeBtn" disabled>üîç ANALIZAR</button>
        
        <div class="loading" id="loading">
            <div>‚è≥ Analizando con Gemini...</div>
        </div>
        
        <div class="error" id="error"></div>
        <div class="feedback" id="feedback">
            üëã Graba y presiona ANALIZAR
        </div>
    </div>

    <script>
    class VoiceRecorder {
        constructor() {
            // ===== TU URL EXACTA =====
            this.APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwM0ZNHOoZ9xr9GVwXXs_pOTwXEwO39heW9f_wQD_fkgxdZlYTBA2tb-1ruWciwumvEZg/exec';
            
            this.mediaRecorder = null;
            this.audioChunks = [];
            this.audioBlob = null;
            this.recordingTime = 0;
            this.timerInterval = null;
            
            this.recordBtn = document.getElementById('recordBtn');
            this.analyzeBtn = document.getElementById('analyzeBtn');
            this.timerElement = document.getElementById('timer');
            this.feedbackElement = document.getElementById('feedback');
            this.loadingElement = document.getElementById('loading');
            this.errorElement = document.getElementById('error');
            this.songInput = document.getElementById('songName');
            
            this.init();
        }

        init() {
            this.recordBtn.addEventListener('click', () => this.toggleRecording());
            this.analyzeBtn.addEventListener('click', () => this.analyzeAudio());
        }

        async toggleRecording() {
            if (this.mediaRecorder?.state === 'recording') {
                this.stopRecording();
            } else {
                await this.startRecording();
            }
        }

        async startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                this.mediaRecorder = new MediaRecorder(stream);
                this.audioChunks = [];
                this.recordingTime = 0;
                
                this.mediaRecorder.ondataavailable = e => this.audioChunks.push(e.data);
                
                this.mediaRecorder.onstop = () => {
                    this.audioBlob = new Blob(this.audioChunks, { type: 'audio/webm' });
                    this.analyzeBtn.disabled = false;
                    stream.getTracks().forEach(t => t.stop());
                };
                
                this.mediaRecorder.start();
                this.recordBtn.textContent = '‚èπÔ∏è DETENER';
                this.recordBtn.classList.add('recording');
                this.startTimer();
                
            } catch (error) {
                this.showError('Error: Permite el micr√≥fono');
            }
        }

        stopRecording() {
            if (this.mediaRecorder?.state === 'recording') {
                this.mediaRecorder.stop();
                this.recordBtn.textContent = 'üé§ GRABAR';
                this.recordBtn.classList.remove('recording');
                this.stopTimer();
            }
        }

        startTimer() {
            this.timerInterval = setInterval(() => {
                this.recordingTime++;
                const m = Math.floor(this.recordingTime / 60);
                const s = this.recordingTime % 60;
                this.timerElement.textContent = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
                if (this.recordingTime >= 30) this.stopRecording();
            }, 1000);
        }

        stopTimer() {
            clearInterval(this.timerInterval);
        }

        async analyzeAudio() {
            if (!this.audioBlob) {
                this.showError('Graba algo primero');
                return;
            }

            const songName = this.songInput.value.trim() || 'canci√≥n sin t√≠tulo';
            
            this.showLoading(true);
            this.hideError();
            this.feedbackElement.innerHTML = '‚è≥ Enviando...';

            try {
                const reader = new FileReader();
                reader.readAsDataURL(this.audioBlob);
                
                reader.onloadend = async () => {
                    const base64Audio = reader.result.split(',')[1];
                    
                    // ===== M√âTODO 1: JSON (el est√°ndar) =====
                    try {
                        const response = await fetch(this.APPS_SCRIPT_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                audio: base64Audio,
                                song: songName,
                                type: 'audio/webm'
                            })
                        });
                        
                        const text = await response.text();
                        console.log('Respuesta:', text);
                        
                        // Intentar parsear
                        try {
                            const json = JSON.parse(text);
                            if (json.success) {
                                this.feedbackElement.innerHTML = json.feedback || '‚úÖ An√°lisis completo';
                            } else {
                                this.feedbackElement.innerHTML = '‚ùå Error: ' + (json.error || 'desconocido');
                            }
                        } catch {
                            this.feedbackElement.innerHTML = text;
                        }
                        
                    } catch (e1) {
                        console.log('M√©todo 1 fall√≥:', e1);
                        
                        // ===== M√âTODO 2: FormData (m√°s compatible) =====
                        try {
                            const formData = new FormData();
                            formData.append('audio', this.audioBlob, 'grabacion.webm');
                            formData.append('song', songName);
                            formData.append('data', JSON.stringify({ 
                                song: songName,
                                type: 'fallback' 
                            }));
                            
                            const response2 = await fetch(this.APPS_SCRIPT_URL, {
                                method: 'POST',
                                body: formData
                            });
                            
                            const text2 = await response2.text();
                            this.feedbackElement.innerHTML = '‚úÖ Recibido (m√©todo 2): ' + text2.substring(0, 200);
                            
                        } catch (e2) {
                            console.log('M√©todo 2 fall√≥:', e2);
                            
                            // ===== M√âTODO 3: URLSearchParams (√∫ltimo recurso) =====
                            try {
                                const params = new URLSearchParams();
                                params.append('data', JSON.stringify({
                                    song: songName,
                                    test: 'true'
                                }));
                                
                                const response3 = await fetch(this.APPS_SCRIPT_URL, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                                    body: params
                                });
                                
                                const text3 = await response3.text();
                                this.feedbackElement.innerHTML = '‚úÖ Recibido: ' + text3;
                                
                            } catch (e3) {
                                this.feedbackElement.innerHTML = '‚ùå Error total. Revisa consola F12';
                                console.error('Todos los m√©todos fallaron:', e1, e2, e3);
                            }
                        }
                    }
                    
                    this.showLoading(false);
                };
                
            } catch (error) {
                this.showError('Error: ' + error.message);
                this.showLoading(false);
            }
        }

        showLoading(show) {
            this.loadingElement.style.display = show ? 'block' : 'none';
            this.analyzeBtn.disabled = show;
        }

        showError(msg) {
            this.errorElement.textContent = msg;
            this.errorElement.style.display = 'block';
            setTimeout(() => this.errorElement.style.display = 'none', 3000);
        }

        hideError() {
            this.errorElement.style.display = 'none';
        }
    }

    new VoiceRecorder();
    </script>
</body>
</html>
